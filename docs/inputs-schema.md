# inputs.yaml Schema Documentation

## Overview

The `inputs.yaml` file is a YAML configuration file that captures all test run parameters for reproducibility. It is automatically generated at the start of each test run and stored in the test pass directory (`$TEST_PASS_DIR/inputs.yaml`).

**Purpose:**
- **Reproducibility**: Preserves exact test configuration for re-running tests with identical settings
- **Auditability**: Documents what parameters were used for a specific test run
- **Snapshot Support**: Enables test pass snapshots to be re-executed in different environments

## File Location

```
/srv/cache/test-run/<test-pass-name>/inputs.yaml
```

Example:
```
/srv/cache/test-run/perf-e5b6ea57-185931-28-12-2025/inputs.yaml
```

## Schema

### Top-Level Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `testType` | string | Yes | Type of test suite: `transport`, `perf`, or `hole-punch` |
| `commandLineArgs` | array | Yes | Original command-line arguments passed to the test runner |
| `environmentVariables` | object | Yes | Key-value pairs of all relevant environment variables |

### Common Environment Variables

These variables are included for all test types:

| Variable | Description |
|----------|-------------|
| `IMAGES_YAML` | The images YAML file used to run the tests (default: `./images.yaml`) |
| `CACHE_DIR` | Cache directory path (default: `/srv/cache`) |
| `TEST_RUN_DIR` | Test run directory path (default: `/srv/cache/test-run`) |
| `SCRIPT_DIR` | Test-specific library scripts directory path |
| `SCRIPT_LIB_DIR` | Shared library scripts directory path |
| `DEBUG` | Debug mode flag (`true` or `false`) |
| `WORKER_COUNT` | Number of parallel test workers |

### Test-Type-Specific Variables

#### Transport Tests

| Variable | Description |
|----------|-------------|
| `TEST_IGNORE` | Test ignore filter (pipe-separated patterns) |
| `TRANSPORT_IGNORE` | Transport ignore filter |
| `SECURE_IGNORE` | Secure channel ignore filter |
| `MUXER_IGNORE` | Muxer ignore filter |
| `FORCE_MATRIX_REBUILD` | Force test matrix regeneration flag |
| `FORCE_IMAGE_REBUILD` | Force Docker image rebuild flag |

#### Perf Tests

| Variable | Description |
|----------|-------------|
| `TEST_IGNORE` | Implementation ignore filter |
| `BASELINE_IGNORE` | Baseline test ignore filter |
| `TRANSPORT_IGNORE` | Transport ignore filter |
| `SECURE_IGNORE` | Secure channel ignore filter |
| `MUXER_IGNORE` | Muxer ignore filter |
| `FORCE_MATRIX_REBUILD` | Force test matrix regeneration flag |
| `FORCE_IMAGE_REBUILD` | Force Docker image rebuild flag |
| `ITERATIONS` | Number of iterations per test (default: 10) |
| `UPLOAD_BYTES` | Bytes to upload per test (default: 1073741824 = 1GB) |
| `DOWNLOAD_BYTES` | Bytes to download per test (default: 1073741824 = 1GB) |
| `DURATION` | Duration per iteration for throughput tests (seconds) |
| `LATENCY_ITERATIONS` | Number of iterations for latency tests (default: 100) |

#### Hole-Punch Tests

| Variable | Description |
|----------|-------------|
| `TEST_IGNORE` | Peer implementation ignore filter |
| `RELAY_IGNORE` | Relay implementation ignore filter |
| `ROUTER_IGNORE` | Router implementation ignore filter |
| `TRANSPORT_IGNORE` | Transport ignore filter |
| `SECURE_IGNORE` | Secure channel ignore filter |
| `MUXER_IGNORE` | Muxer ignore filter |
| `FORCE_MATRIX_REBUILD` | Force test matrix regeneration flag |
| `FORCE_IMAGE_REBUILD` | Force Docker image rebuild flag |

## Example

```yaml
# Generated inputs.yaml for a "perf" test run
# This file captures all configuration for reproducibility
# Created: 2026-01-02T03:04:06Z

testType: perf

commandLineArgs:
  - "--test-ignore"
  - "!rust-v0.56"
  - "--baseline-ignore"
  - "~all"
  - "--transport-ignore"
  - "quic-v1"
  - "--secure-ignore"
  - "tls"
  - "--muxer-ignore"
  - "mplex"
  - "--force-matrix-rebuild"
  - "--yes"

environmentVariables:
  IMAGES_YAML: "./images.yaml"
  CACHE_DIR: "/srv/cache"
  TEST_RUN_DIR: "/srv/cache/test-run"
  SCRIPT_DIR: "/srv/test-plans/perf/lib"
  SCRIPT_LIB_DIR: "/srv/test-plans/perf/lib/../../lib"
  DEBUG: "false"
  WORKER_COUNT: "1"
  TEST_IGNORE: "!rust-v0.56"
  TRANSPORT_IGNORE: "quic-v1"
  SECURE_IGNORE: "tls"
  MUXER_IGNORE: "mplex"
  FORCE_MATRIX_REBUILD: "true"
  FORCE_IMAGE_REBUILD: "false"
  BASELINE_IGNORE: "~all"
  ITERATIONS: "10"
  UPLOAD_BYTES: "1073741824"
  DOWNLOAD_BYTES: "1073741824"
  DURATION: ""
  LATENCY_ITERATIONS: "100"
```

## Generation

### When Generated

The `inputs.yaml` file is automatically generated at the start of each test run, after:
1. Command-line arguments are parsed
2. Environment variables are set
3. Test pass directory is created

### Generation Code

The file is generated by the `generate_inputs_yaml()` function in `lib/lib-inputs-yaml.sh`:

```bash
generate_inputs_yaml "$TEST_PASS_DIR/inputs.yaml" "$TEST_TYPE" "${ORIGINAL_ARGS[@]}"
```

**Implementation Details:**
- **Source**: `lib/lib-inputs-yaml.sh:17-81`
- **Called from**: `perf/run.sh:389` (and similar locations in other test suites)
- **Parameters**:
  1. Output file path (where to write the file)
  2. Test type (`transport`, `perf`, or `hole-punch`)
  3. Original command-line arguments (captured before parsing)

### Generation Process

1. **Capture Original Args**: Before argument parsing, the script saves `ORIGINAL_ARGS=("$@")` (see `perf/run.sh:24`)
2. **Parse Arguments**: The test runner parses all arguments and sets environment variables
3. **Create Test Pass Dir**: A unique test pass directory is created with format `<type>-<key>-<timestamp>`
4. **Generate File**: The `generate_inputs_yaml()` function writes all configuration to `$TEST_PASS_DIR/inputs.yaml`

## Loading

### Purpose

When an `inputs.yaml` file exists in the current directory, the test runner can load it to reproduce a previous test run.

### Loading Code

The file is loaded by inline functions at the top of each test runner (e.g., `perf/run.sh:30-65`):

```bash
load_inputs_yaml_inline() {
  local inputs_file="${1:-inputs.yaml}"
  # Loads and exports environment variables from inputs.yaml using yq
  # Source: perf/run.sh:30-48
}

get_yaml_args_inline() {
  local inputs_file="${1:-inputs.yaml}"
  # Extracts command-line arguments array from inputs.yaml
  # Source: perf/run.sh:51-57
}
```

### Loading Process

1. **Bootstrap Phase**: Before any libraries are loaded, check if `inputs.yaml` exists in current directory (perf/run.sh:60-65)
2. **Load Variables**: Extract and export all environment variables from `.environmentVariables` using `yq` (perf/run.sh:41-45)
3. **Load Arguments**: Extract command-line arguments array from `.commandLineArgs[]` using `yq` (perf/run.sh:56)
4. **Merge with CLI**: Append any new command-line arguments - CLI args take precedence and override inputs.yaml (perf/run.sh:68)
5. **Continue Execution**: Proceed with test execution using merged configuration

### Usage Example

```bash
# Copy inputs.yaml from a previous test run
cp /srv/cache/test-run/perf-abc123/inputs.yaml ./

# Re-run tests with exact same configuration
cd perf
./run.sh

# Or override specific parameters
./run.sh --iterations 20
```

## Snapshot Modification

When creating a test pass snapshot (using `--snapshot`), the `inputs.yaml` file is modified to work in the snapshot context.

### Modifications

The `modify_inputs_for_snapshot()` function (in `lib/lib-inputs-yaml.sh:87-111`) adjusts paths:

| Original Variable | Snapshot Value | Reason |
|------------------|----------------|--------|
| `IMAGES_YAML` | `./images.yaml` | Images config is copied to snapshot root |
| `CACHE_DIR` | `./` | Cache artifacts are packaged in snapshot root |
| `TEST_RUN_DIR` | `./re-run` | Test re-runs go to local directory |
| `SCRIPT_DIR` | `./lib` | Test-specific scripts are packaged in snapshot |
| `SCRIPT_LIB_DIR` | `./lib` | Shared libraries are packaged in snapshot |
| `--snapshot` flag | Removed from commandLineArgs | Prevents recursive snapshot creation |

Implementation uses `yq eval -i` to modify the YAML in-place:
```bash
yq eval -i '.environmentVariables.IMAGES_YAML = "./images.yaml"' "$inputs_file"
yq eval -i '.environmentVariables.CACHE_DIR = "./"' "$inputs_file"
yq eval -i '.environmentVariables.TEST_RUN_DIR = "./re-run"' "$inputs_file"
yq eval -i '.environmentVariables.SCRIPT_DIR = "./lib"' "$inputs_file"
yq eval -i '.environmentVariables.SCRIPT_LIB_DIR = "./lib"' "$inputs_file"
yq eval -i 'del(.commandLineArgs[] | select(. == "--snapshot"))' "$inputs_file"
```

### Snapshot Usage

```bash
# Extract a snapshot
unzip test-pass-snapshot.zip
cd test-pass-snapshot

# Run with snapshot's inputs.yaml
./run.sh
```

The modified `inputs.yaml` ensures the test runner uses snapshot-local resources instead of system-wide paths.

## Use Cases

### 1. Reproducing Test Failures

```bash
# A test run failed
# Copy its inputs.yaml
cp /srv/cache/test-run/perf-failed-run/inputs.yaml ./inputs.yaml

# Re-run with exact same configuration
cd perf && ./run.sh
```

### 2. Debugging with Debug Mode

```bash
# Manually edit inputs.yaml
yq eval -i '.environmentVariables.DEBUG = "true"' inputs.yaml

# Re-run with debug enabled
./run.sh
```

### 3. Cross-Environment Testing

```bash
# Generate inputs.yaml on one machine
./run.sh --test-select "rust-v0.56" --snapshot

# Copy snapshot to another machine
# Extract and run
unzip snapshot.zip
cd snapshot && ./run.sh
```

### 4. Audit Trail

```bash
# Review what configuration was used for a specific test run
cat /srv/cache/test-run/perf-abc123/inputs.yaml

# See exact command that was run
yq eval '.commandLineArgs[]' /srv/cache/test-run/perf-abc123/inputs.yaml
```

## Related Files

- **Generation**: `lib/lib-inputs-yaml.sh` - Functions to generate and modify inputs.yaml
  - `generate_inputs_yaml()` function at lines 17-81
  - `modify_inputs_for_snapshot()` function at lines 87-111
- **Loading**: Inline functions in each test runner's bootstrap section
  - `perf/run.sh:30-48` - `load_inputs_yaml_inline()`
  - `perf/run.sh:51-57` - `get_yaml_args_inline()`
  - `perf/run.sh:60-71` - Bootstrap logic
- **Usage**:
  - `perf/run.sh:389` - Calls `generate_inputs_yaml()`
  - Similar patterns in `transport/run.sh` and `hole-punch/run.sh`
- **Snapshot Creation**: `lib/lib-snapshot-creation.sh` - Creates snapshots and modifies inputs.yaml
