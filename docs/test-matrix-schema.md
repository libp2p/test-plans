# test-matrix.yaml Schema Documentation

## Overview

The `test-matrix.yaml` file contains all test combinations that will be executed in a test run. It is automatically generated by the `generate-tests.sh` script and includes both selected tests (to be executed) and ignored tests (filtered out but documented for reference).

**Generation Location**: `$TEST_PASS_DIR/test-matrix.yaml`

**Generated By**:
- `perf/lib/generate-tests.sh`
- `transport/lib/generate-tests.sh`
- `hole-punch/lib/generate-tests.sh`

**Purpose**:
- Define all test combinations to execute
- Document filter criteria used for test selection
- Track which tests were selected vs ignored
- Enable test pass reproducibility
- Support content-addressed caching

---

## File Location

```
/srv/cache/test-run/<test-pass-name>/test-matrix.yaml
```

**Cached Copy** (for faster subsequent runs):
```
/srv/cache/test-run-matrix/<test-type>-<cache-key>.yaml
```

Example:
```
/srv/cache/test-run/perf-e5b6ea57-185931-28-12-2025/test-matrix.yaml
/srv/cache/test-run-matrix/perf-e5b6ea57.yaml
```

---

## Schema Structure

### Top-Level Sections

All test types include these top-level sections:

```yaml
metadata:           # Test run configuration and statistics
tests:              # Selected tests to execute
ignoredTests:       # Tests filtered out but documented
```

**Perf-specific sections** (additional):
```yaml
baselines:          # Selected baseline tests
ignoredBaselines:   # Ignored baseline tests
```

---

## Metadata Section

### Common Metadata Fields (All Test Types)

| Field | Type | Description |
|-------|------|-------------|
| `ignore` | string | Test/implementation ignore filter used |
| `transportIgnore` | string | Transport ignore filter used |
| `secureIgnore` | string | Secure channel ignore filter used |
| `muxerIgnore` | string | Muxer ignore filter used |
| `totalTests` | integer | Number of selected tests |
| `ignoredTests` | integer | Number of ignored tests |
| `debug` | boolean | Debug mode enabled (`true`/`false`) |

### Perf-Specific Metadata

Additional fields for perf tests:

| Field | Type | Description |
|-------|------|-------------|
| `baselineIgnore` | string | Baseline ignore filter used |
| `uploadBytes` | integer | Bytes to upload per test (default: 1073741824) |
| `downloadBytes` | integer | Bytes to download per test (default: 1073741824) |
| `iterations` | integer | Number of iterations per test (default: 10) |
| `durationPerIteration` | integer | Duration per iteration in seconds |
| `latencyIterations` | integer | Number of latency test iterations (default: 100) |
| `totalBaselines` | integer | Number of selected baseline tests |
| `ignoredBaselines` | integer | Number of ignored baseline tests |

### Hole-Punch-Specific Metadata

Additional fields for hole-punch tests:

| Field | Type | Description |
|-------|------|-------------|
| `relayIgnore` | string | Relay implementation ignore filter used |
| `routerIgnore` | string | Router implementation ignore filter used |

### Example: Perf Metadata

```yaml
metadata:
  ignore: "!rust-v0.56"
  baselineIgnore: "~all"
  transportIgnore: "quic-v1"
  secureIgnore: "tls"
  muxerIgnore: "mplex"
  uploadBytes: 1073741824
  downloadBytes: 1073741824
  iterations: 10
  durationPerIteration: 20
  latencyIterations: 100
  totalBaselines: 3
  ignoredBaselines: 0
  totalTests: 20
  ignoredTests: 156
  debug: false
```

### Example: Transport Metadata

```yaml
metadata:
  ignore: "!rust-v0.56|~browsers"
  transportIgnore: ""
  secureIgnore: ""
  muxerIgnore: ""
  totalTests: 10
  ignoredTests: 2340
  debug: true
```

### Example: Hole-Punch Metadata

```yaml
metadata:
  ignore: "!rust-v0.56"
  relayIgnore: "!rust-v0.56"
  routerIgnore: "!linux"
  transportIgnore: "webrtc-direct"
  secureIgnore: ""
  muxerIgnore: ""
  totalTests: 8
  ignoredTests: 0
  debug: false
```

---

## Test Entry Structure

### Standard Test Entry (Transport/Perf)

Each test entry contains:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | Yes | Human-readable test identifier |
| `transport` | string | Yes | Transport name (tcp, quic-v1, ws, etc.) |
| `secureChannel` | string/null | Yes | Secure channel (noise, tls) or `null` for standalone transports |
| `muxer` | string/null | Yes | Muxer (yamux, mplex) or `null` for standalone transports |
| `dialer` | object | Yes | Dialer configuration |
| `listener` | object | Yes | Listener configuration |

#### Dialer/Listener Configuration

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | Yes | Implementation ID |
| `imageName` | string | Yes | Docker image name |
| `snapshot` | string | No | Path to GitHub snapshot (if source type is GitHub) |
| `dialOnly` | boolean | No | `true` if implementation can only dial (transport only) |

### Hole-Punch Test Entry

Hole-punch tests include additional fields:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `relay` | object | Yes | Relay server configuration |
| `dialerRouter` | object | Yes | Dialer's NAT router configuration |
| `listenerRouter` | object | Yes | Listener's NAT router configuration |

#### Relay/Router Configuration

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `id` | string | Yes | Implementation ID |
| `imageName` | string | Yes | Docker image name |

---

## Complete Examples

### Perf Test Matrix

```yaml
metadata:
  ignore: "!rust-v0.56"
  baselineIgnore: ""
  transportIgnore: ""
  secureIgnore: ""
  muxerIgnore: ""
  uploadBytes: 1073741824
  downloadBytes: 1073741824
  iterations: 10
  durationPerIteration: 20
  latencyIterations: 100
  totalBaselines: 3
  ignoredBaselines: 0
  totalTests: 16
  ignoredTests: 140
  debug: false

baselines:
  - id: "iperf x iperf (tcp)"
    transport: tcp
    secureChannel: null
    muxer: null
    dialer:
      id: iperf
      imageName: perf-baselines-iperf
    listener:
      id: iperf
      imageName: perf-baselines-iperf

  - id: "https x https (https)"
    transport: https
    secureChannel: null
    muxer: null
    dialer:
      id: https
      imageName: perf-baselines-https
    listener:
      id: https
      imageName: perf-baselines-https

tests:
  - id: "rust-v0.56 x rust-v0.56 (tcp, noise, yamux)"
    transport: tcp
    secureChannel: noise
    muxer: yamux
    dialer:
      id: rust-v0.56
      imageName: perf-implementations-rust-v0.56
    listener:
      id: rust-v0.56
      imageName: perf-implementations-rust-v0.56

  - id: "rust-v0.56 x rust-v0.56 (quic-v1)"
    transport: quic-v1
    secureChannel: null
    muxer: null
    dialer:
      id: rust-v0.56
      imageName: perf-implementations-rust-v0.56
    listener:
      id: rust-v0.56
      imageName: perf-implementations-rust-v0.56

ignoredBaselines: []

ignoredTests:
  - id: "go-v0.45 x go-v0.45 (tcp, noise, yamux)"
    transport: tcp
    secureChannel: noise
    muxer: yamux
    dialer:
      id: go-v0.45
      imageName: perf-implementations-go-v0.45
    listener:
      id: go-v0.45
      imageName: perf-implementations-go-v0.45
```

### Transport Test Matrix

```yaml
metadata:
  ignore: "!rust-v0.56|~browsers"
  transportIgnore: ""
  secureIgnore: ""
  muxerIgnore: ""
  totalTests: 10
  ignoredTests: 2340
  debug: true

tests:
  - id: "rust-v0.56 x rust-v0.56 (tcp, noise, yamux)"
    transport: tcp
    secureChannel: noise
    muxer: yamux
    dialer:
      id: rust-v0.56
      imageName: transport-implementations-rust-v0.56
      snapshot: snapshots/70082df7e6181722630eabc5de5373733aac9a21.zip
    listener:
      id: rust-v0.56
      imageName: transport-implementations-rust-v0.56
      snapshot: snapshots/70082df7e6181722630eabc5de5373733aac9a21.zip

  - id: "rust-v0.56 x rust-v0.56 (quic-v1)"
    transport: quic-v1
    secureChannel: null
    muxer: null
    dialer:
      id: rust-v0.56
      imageName: transport-implementations-rust-v0.56
      snapshot: snapshots/70082df7e6181722630eabc5de5373733aac9a21.zip
    listener:
      id: rust-v0.56
      imageName: transport-implementations-rust-v0.56
      snapshot: snapshots/70082df7e6181722630eabc5de5373733aac9a21.zip

  # Browser implementation (dialOnly)
  - id: "chromium-rust-v0.56 x rust-v0.56 (ws, noise, yamux)"
    transport: ws
    secureChannel: noise
    muxer: yamux
    dialer:
      id: chromium-rust-v0.56
      imageName: transport-implementations-chromium-rust-v0.56
      dialOnly: true
    listener:
      id: rust-v0.56
      imageName: transport-implementations-rust-v0.56
      snapshot: snapshots/70082df7e6181722630eabc5de5373733aac9a21.zip

ignoredTests:
  - id: "rust-v0.53 x rust-v0.53 (tcp, noise, yamux)"
    transport: tcp
    secureChannel: noise
    muxer: yamux
    dialer:
      id: rust-v0.53
      imageName: transport-implementations-rust-v0.53
      snapshot: snapshots/b7914e407da34c99fb76dcc300b3d44b9af97fac.zip
    listener:
      id: rust-v0.53
      imageName: transport-implementations-rust-v0.53
      snapshot: snapshots/b7914e407da34c99fb76dcc300b3d44b9af97fac.zip
```

### Hole-Punch Test Matrix

```yaml
metadata:
  ignore: "!rust-v0.56"
  relayIgnore: "!rust-v0.56"
  routerIgnore: "!linux"
  transportIgnore: ""
  secureIgnore: ""
  muxerIgnore: ""
  totalTests: 8
  ignoredTests: 0
  debug: false

tests:
  - id: "rust-v0.56 x rust-v0.56 (tcp, noise, yamux) [dr: linux, rly: rust-v0.56, lr: linux]"
    transport: tcp
    secureChannel: noise
    muxer: yamux
    dialer:
      id: rust-v0.56
      imageName: hole-punch-implementations-rust-v0.56
    listener:
      id: rust-v0.56
      imageName: hole-punch-implementations-rust-v0.56
    relay:
      id: rust-v0.56
      imageName: hole-punch-relays-rust-v0.56
    dialerRouter:
      id: linux
      imageName: hole-punch-routers-linux
    listenerRouter:
      id: linux
      imageName: hole-punch-routers-linux

  - id: "rust-v0.56 x rust-v0.56 (quic-v1) [dr: linux, rly: rust-v0.56, lr: linux]"
    transport: quic-v1
    secureChannel: null
    muxer: null
    dialer:
      id: rust-v0.56
      imageName: hole-punch-implementations-rust-v0.56
    listener:
      id: rust-v0.56
      imageName: hole-punch-implementations-rust-v0.56
    relay:
      id: rust-v0.56
      imageName: hole-punch-relays-rust-v0.56
    dialerRouter:
      id: linux
      imageName: hole-punch-routers-linux
    listenerRouter:
      id: linux
      imageName: hole-punch-routers-linux

ignoredTests: []
```

---

## Generation Process

### Overview

The test matrix is generated by permuting implementations across dimensions:

**All Test Types**:
1. Dialer implementation Ã— Listener implementation
2. Common transports between dialer and listener
3. For non-standalone transports:
   - Common secure channels
   - Common muxers

**Hole-Punch Additional Dimensions**:
4. Relay implementation
5. Dialer router implementation
6. Listener router implementation

### Generation Flow

**Step 1: Load and Expand Filters** (generate-tests.sh lines 21-76)
```bash
# Load aliases from images.yaml
load_aliases

# Expand filter strings with alias resolution
EXPANDED_TEST_IGNORE=$(expand_filter_string "${TEST_IGNORE}" all_image_ids)
```

**Step 2: Check Cache** (generate-tests.sh lines ~120-130)
```bash
# Check if cached test-matrix.yaml exists for this configuration
if check_and_load_cache; then
  exit 0  # Cache hit, use existing file
fi
```

**Step 3: Apply Filters** (generate-tests.sh lines ~135-165)
```bash
# Filter implementations, transports, secure channels, muxers
filtered_image_ids=($(filter_entities "implementations"))
filtered_transport_names=($(filter_names "transports"))
filtered_secure_names=($(filter_names "secureChannels"))
filtered_muxer_names=($(filter_names "muxers"))
```

**Step 4: Generate Test Combinations** (generate-tests.sh lines ~213-385)
```bash
# Nested iteration through all dimensions
for dialer_id in "${all_image_ids[@]}"; do
  for listener_id in "${all_image_ids[@]}"; do
    for transport in ${common_transports}; do
      if is_standalone_transport "$transport"; then
        # Add test without secure channel or muxer
      else
        for secure in ${common_secure}; do
          for muxer in ${common_muxers}; do
            # Add test with full stack
          done
        done
      fi
    done
  done
done
```

**Step 5: Write YAML** (generate-tests.sh lines ~387-477)
```bash
# Write metadata section
cat > "${TEST_PASS_DIR}/test-matrix.yaml" <<EOF
metadata:
  ...
EOF

# Write selected tests
output_tests "tests" "implementations" main_tests

# Write ignored tests
output_tests "ignoredTests" "implementations" ignored_main_tests
```

**Step 6: Cache Results** (generate-tests.sh line ~475)
```bash
save_to_cache "${TEST_PASS_DIR}/test-matrix.yaml" "${TEST_RUN_KEY}" \
  "${CACHE_DIR}/test-run-matrix" "${TEST_TYPE}"
```

---

## Caching Mechanism

### Cache Key Computation

The cache key is computed from:
- Content hash of images.yaml
- All filter values (TEST_IGNORE, TRANSPORT_IGNORE, etc.)
- Debug flag

This ensures identical configurations reuse cached matrices.

### Cache Locations

```
# Primary location (test pass directory)
/srv/cache/test-run/<test-pass-name>/test-matrix.yaml

# Cached copy (for reuse)
/srv/cache/test-run-matrix/<test-type>-<cache-key>.yaml
```

### Cache Invalidation

Cache is invalidated when:
- `--force-matrix-rebuild` flag is used
- images.yaml content changes
- Any filter value changes
- Debug flag changes

---

## Usage in Test Execution

### Reading Test Configuration

Test runners read from test-matrix.yaml using `yq`:

```bash
# Get test count
TEST_COUNT=$(yq eval '.tests | length' "${TEST_PASS_DIR}/test-matrix.yaml")

# Read specific test
DIALER_ID=$(yq eval ".tests[${i}].dialer.id" "${TEST_PASS_DIR}/test-matrix.yaml")
TRANSPORT=$(yq eval ".tests[${i}].transport" "${TEST_PASS_DIR}/test-matrix.yaml")
```

### Test Index

Tests are accessed by zero-based index:
- Index 0: First test in `.tests[]` array
- Index N-1: Last test in `.tests[]` array

The test runner iterates through all tests:

```bash
for ((i=0; i<TEST_COUNT; i++)); do
  run_single_test "${i}" "tests" "${RESULTS_FILE}"
done
```

---

## Related Files

- **Generation**: `perf/lib/generate-tests.sh`, `transport/lib/generate-tests.sh`, `hole-punch/lib/generate-tests.sh`
- **Source Data**: `images.yaml` (defines implementations and their capabilities)
- **Filter Engine**: `lib/lib-filter-engine.sh` (handles alias expansion and negation)
- **Caching**: `lib/lib-test-caching.sh` (content-addressed caching functions)
- **Test Execution**: `perf/lib/run-single-test.sh`, `transport/lib/run-single-test.sh`, `hole-punch/lib/run-single-test.sh`

---

## See Also

- **[docs/images-yaml-schema.md](images-yaml-schema.md)** - images.yaml schema specification
- **[docs/inputs-schema.md](inputs-schema.md)** - inputs.yaml schema specification
- **[docs/results-schema.md](results-schema.md)** - results.yaml schema specification
- **[docs/overall-flow.md](overall-flow.md)** - Test execution flow overview
