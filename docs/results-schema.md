# results.yaml Schema Documentation

## Overview

The `results.yaml` file contains aggregated test results from a complete test run. It is generated at the end of test execution and includes metadata, summary statistics, and individual test results with measurements.

**Generation Location**: `$TEST_PASS_DIR/results.yaml`

**Generated By**: Test runners after all tests complete
- `perf/run.sh:671-785`
- `transport/run.sh` (similar location)
- `hole-punch/run.sh` (similar location)

**Purpose**:
- Aggregate all test results in single file
- Provide summary statistics (pass/fail counts)
- Include test run metadata (platform, duration, worker count)
- Enable result analysis and dashboard generation

---

## File Location

```
/srv/cache/test-run/<test-pass-name>/results.yaml
```

Example:
```
/srv/cache/test-run/perf-e5b6ea57-185931-28-12-2025/results.yaml
/srv/cache/test-run/transport-3fb576d7-123040-14-01-2026/results.yaml
/srv/cache/test-run/hole-punch-73fe56a0-123040-14-01-2026/results.yaml
```

---

## Schema Structure

### Top-Level Sections

All test types include:

```yaml
metadata:       # Test run information
summary:        # Pass/fail statistics
tests:          # Individual test results
```

**Perf-specific additions**:
```yaml
baselines:      # Baseline test results (optional if baseline tests run)
```

---

## Metadata Section

### Common Metadata Fields

| Field | Type | Description |
|-------|------|-------------|
| `testPass` | string | Test pass directory name |
| `startedAt` | string | ISO 8601 timestamp when tests started |
| `completedAt` | string | ISO 8601 timestamp when tests completed |
| `duration` | string | Total test run duration (e.g., "26s", "5m30s") |
| `platform` | string | CPU architecture (x86_64, arm64, etc.) |
| `os` | string | Operating system name |
| `workerCount` | integer | Number of parallel workers used |

### Example

```yaml
metadata:
  testPass: perf-e5b6ea57-185931-28-12-2025
  startedAt: 2026-01-02T03:04:06Z
  completedAt: 2026-01-02T03:15:30Z
  duration: 11m24s
  platform: x86_64
  os: Linux
  workerCount: 1
```

---

## Summary Section

### Summary Fields

| Field | Type | Description |
|-------|------|-------------|
| `total` | integer | Total number of tests executed |
| `passed` | integer | Number of tests that passed |
| `failed` | integer | Number of tests that failed |

### Example

```yaml
summary:
  total: 156
  passed: 148
  failed: 8
```

---

## Tests Section

### Standard Test Entry (Transport/Perf)

Each test result contains:

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `name` | string | Yes | Test identifier from test-matrix.yaml |
| `dialer` | string | Yes | Dialer implementation ID |
| `listener` | string | Yes | Listener implementation ID |
| `transport` | string | Yes | Transport used (tcp, quic-v1, etc.) |
| `secureChannel` | string/null | Yes | Secure channel used or `null` |
| `muxer` | string/null | Yes | Muxer used or `null` |
| `status` | string | Yes | Test result: `pass` or `fail` |
| `duration` | string | Yes | Test execution time (e.g., "3s", "45s") |

### Perf-Specific Measurement Fields

Perf tests include additional measurement data:

#### Upload Measurements

| Field | Type | Description |
|-------|------|-------------|
| `upload.bandwidth.mean` | float | Mean upload bandwidth (Mbps) |
| `upload.bandwidth.median` | float | Median upload bandwidth (Mbps) |
| `upload.bandwidth.min` | float | Minimum upload bandwidth (Mbps) |
| `upload.bandwidth.max` | float | Maximum upload bandwidth (Mbps) |
| `upload.bandwidth.stddev` | float | Standard deviation (Mbps) |
| `upload.bandwidth.unit` | string | Always "Mbps" |

#### Download Measurements

| Field | Type | Description |
|-------|------|-------------|
| `download.bandwidth.mean` | float | Mean download bandwidth (Mbps) |
| `download.bandwidth.median` | float | Median download bandwidth (Mbps) |
| `download.bandwidth.min` | float | Minimum download bandwidth (Mbps) |
| `download.bandwidth.max` | float | Maximum download bandwidth (Mbps) |
| `download.bandwidth.stddev` | float | Standard deviation (Mbps) |
| `download.bandwidth.unit` | string | Always "Mbps" |

#### Latency Measurements

| Field | Type | Description |
|-------|------|-------------|
| `latency.mean` | float | Mean latency (ms) |
| `latency.median` | float | Median latency (ms) |
| `latency.min` | float | Minimum latency (ms) |
| `latency.max` | float | Maximum latency (ms) |
| `latency.p50` | float | 50th percentile (ms) |
| `latency.p90` | float | 90th percentile (ms) |
| `latency.p95` | float | 95th percentile (ms) |
| `latency.p99` | float | 99th percentile (ms) |
| `latency.stddev` | float | Standard deviation (ms) |
| `latency.unit` | string | Always "ms" |

### Hole-Punch-Specific Fields

Hole-punch tests include additional entity fields and measurements:

#### Additional Entity Fields

| Field | Type | Description |
|-------|------|-------------|
| `relay` | string | Relay implementation ID |
| `dialerRouter` | string | Dialer's NAT router ID |
| `listenerRouter` | string | Listener's NAT router ID |

#### Latency Measurements

| Field | Type | Description |
|-------|------|-------------|
| `latency.handshake_plus_one_rtt` | float | DCUtR handshake + 1 RTT time (ms) |
| `latency.ping_rtt` | float | Ping round-trip time over direct connection (ms) |
| `latency.unit` | string | Always "ms" |

---

## Complete Examples

### Perf Test Results

```yaml
metadata:
  testPass: perf-e5b6ea57-185931-28-12-2025
  startedAt: 2026-01-02T03:04:06Z
  completedAt: 2026-01-02T03:15:30Z
  duration: 11m24s
  platform: x86_64
  os: Linux
  workerCount: 1

summary:
  total: 20
  passed: 18
  failed: 2

baselines:
  - name: "iperf x iperf (tcp)"
    dialer: iperf
    listener: iperf
    transport: tcp
    secureChannel: null
    muxer: null
    status: pass
    duration: 45s
    upload:
      bandwidth:
        mean: 9234.56
        median: 9241.23
        min: 9180.45
        max: 9289.12
        stddev: 28.67
        unit: Mbps
    download:
      bandwidth:
        mean: 9256.78
        median: 9263.45
        min: 9198.23
        max: 9312.89
        stddev: 31.23
        unit: Mbps
    latency:
      mean: 0.12
      median: 0.11
      min: 0.09
      max: 0.18
      p50: 0.11
      p90: 0.15
      p95: 0.16
      p99: 0.18
      stddev: 0.02
      unit: ms

tests:
  - name: "rust-v0.56 x rust-v0.56 (tcp, noise, yamux)"
    dialer: rust-v0.56
    listener: rust-v0.56
    transport: tcp
    secureChannel: noise
    muxer: yamux
    status: pass
    duration: 47s
    upload:
      bandwidth:
        mean: 1234.56
        median: 1241.23
        min: 1180.45
        max: 1289.12
        stddev: 28.67
        unit: Mbps
    download:
      bandwidth:
        mean: 1256.78
        median: 1263.45
        min: 1198.23
        max: 1312.89
        stddev: 31.23
        unit: Mbps
    latency:
      mean: 1.45
      median: 1.42
      min: 0.89
      max: 2.34
      p50: 1.42
      p90: 1.98
      p95: 2.12
      p99: 2.28
      stddev: 0.32
      unit: ms

  - name: "rust-v0.56 x rust-v0.56 (quic-v1)"
    dialer: rust-v0.56
    listener: rust-v0.56
    transport: quic-v1
    secureChannel: null
    muxer: null
    status: pass
    duration: 43s
    upload:
      bandwidth:
        mean: 2134.56
        median: 2141.23
        min: 2080.45
        max: 2189.12
        stddev: 25.67
        unit: Mbps
    download:
      bandwidth:
        mean: 2156.78
        median: 2163.45
        min: 2098.23
        max: 2212.89
        stddev: 28.23
        unit: Mbps
    latency:
      mean: 0.85
      median: 0.82
      min: 0.69
      max: 1.24
      p50: 0.82
      p90: 1.08
      p95: 1.15
      p99: 1.21
      stddev: 0.15
      unit: ms

  - name: "go-v0.45 x go-v0.45 (tcp, noise, yamux)"
    dialer: go-v0.45
    listener: go-v0.45
    transport: tcp
    secureChannel: noise
    muxer: yamux
    status: fail
    duration: 180s
```

### Transport Test Results

```yaml
metadata:
  testPass: transport-3fb576d7-123040-14-01-2026
  startedAt: 2026-01-14T12:30:40Z
  completedAt: 2026-01-14T12:35:15Z
  duration: 4m35s
  platform: x86_64
  os: Linux
  workerCount: 8

summary:
  total: 156
  passed: 148
  failed: 8

tests:
  - name: "rust-v0.56 x rust-v0.56 (tcp, noise, yamux)"
    dialer: rust-v0.56
    listener: rust-v0.56
    transport: tcp
    secureChannel: noise
    muxer: yamux
    status: pass
    duration: 3s

  - name: "rust-v0.56 x go-v0.45 (quic-v1)"
    dialer: rust-v0.56
    listener: go-v0.45
    transport: quic-v1
    secureChannel: null
    muxer: null
    status: pass
    duration: 4s

  - name: "chromium-js-v3.x x rust-v0.56 (ws, noise, yamux)"
    dialer: chromium-js-v3.x
    listener: rust-v0.56
    transport: ws
    secureChannel: noise
    muxer: yamux
    status: pass
    duration: 5s

  - name: "go-v0.45 x go-v0.45 (tcp, noise, yamux)"
    dialer: go-v0.45
    listener: go-v0.45
    transport: tcp
    secureChannel: noise
    muxer: yamux
    status: fail
    duration: 40s
```

### Hole-Punch Test Results

```yaml
metadata:
  testPass: hole-punch-73fe56a0-123040-14-01-2026
  startedAt: 2026-01-14T19:30:40Z
  completedAt: 2026-01-14T19:31:06Z
  duration: 26s
  platform: x86_64
  os: Linux
  workerCount: 1

summary:
  total: 10
  passed: 8
  failed: 2

tests:
  - name: "rust-v0.56 x rust-v0.56 (tcp, noise, yamux) [dr: linux, rly: rust-v0.56, lr: linux]"
    dialer: rust-v0.56
    listener: rust-v0.56
    relay: rust-v0.56
    dialerRouter: linux
    listenerRouter: linux
    transport: tcp
    secureChannel: noise
    muxer: yamux
    status: pass
    duration: 12s
    latency:
      handshake_plus_one_rtt: 234.56
      ping_rtt: 1.23
      unit: ms

  - name: "rust-v0.56 x rust-v0.56 (quic-v1) [dr: linux, rly: rust-v0.56, lr: linux]"
    dialer: rust-v0.56
    listener: rust-v0.56
    relay: rust-v0.56
    dialerRouter: linux
    listenerRouter: linux
    transport: quic-v1
    secureChannel: null
    muxer: null
    status: pass
    duration: 10s
    latency:
      handshake_plus_one_rtt: 189.45
      ping_rtt: 0.98
      unit: ms

  - name: "rust-v0.56 x rust-v0.56 (ws, tls, mplex) [dr: linux, rly: rust-v0.56, lr: linux]"
    dialer: rust-v0.56
    listener: rust-v0.56
    relay: rust-v0.56
    dialerRouter: linux
    listenerRouter: linux
    transport: ws
    secureChannel: tls
    muxer: mplex
    status: fail
    duration: 180s
```

---

## Generation Process

### Collection Phase

During test execution, individual test results are written to:
- **Temporary file**: `$TEST_PASS_DIR/results.yaml.tmp` (or `baseline-results.yaml.tmp` for baselines)
- **Individual files**: `$TEST_PASS_DIR/results/<test-name>.yaml`

Results are appended with file locking to prevent race conditions:

```bash
(
  flock -x 200
  cat >> "${RESULTS_FILE}" <<EOF
  - name: ${TEST_NAME}
    dialer: ${DIALER_ID}
    listener: ${LISTENER_ID}
    ...
EOF
) 200>/tmp/results.lock
```

### Aggregation Phase

After all tests complete, the runner:

1. **Counts pass/fail** from temporary results files:
   ```bash
   PASSED=$(yq eval '[.[] | select(.status == "pass")] | length' results.yaml.tmp)
   FAILED=$(yq eval '[.[] | select(.status == "fail")] | length' results.yaml.tmp)
   ```

2. **Generates metadata**:
   ```bash
   STARTED_AT=$(cat "${TEST_PASS_DIR}/.start_time")
   COMPLETED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
   DURATION=$(calculate_duration "$STARTED_AT" "$COMPLETED_AT")
   ```

3. **Creates final results.yaml**:
   ```bash
   cat > "${TEST_PASS_DIR}/results.yaml" <<EOF
   metadata:
     testPass: ${TEST_PASS_NAME}
     startedAt: ${STARTED_AT}
     ...

   summary:
     total: $((PASSED + FAILED))
     passed: ${PASSED}
     failed: ${FAILED}

   tests:
   EOF

   # Append test results
   yq eval '.[]' results.yaml.tmp >> results.yaml
   ```

---

## Status Values

### Pass Criteria

A test is marked as `status: pass` when:
- Test application exits with code 0
- All expected measurements are present (if applicable)
- No timeout occurred

### Fail Criteria

A test is marked as `status: fail` when:
- Test application exits with non-zero code
- Test timeout (default: 180 seconds for hole-punch, 300 seconds for perf/transport)
- Docker container crash or error
- Missing required measurements

---

## Measurement Data

### How Measurements Are Captured

Test applications output measurements to stdout in YAML format:

#### Perf Test Output (from dialer)

```yaml
upload:
  bandwidth:
    mean: 1234.56
    median: 1241.23
    min: 1180.45
    max: 1289.12
    stddev: 28.67
    unit: Mbps
download:
  bandwidth:
    mean: 1256.78
    median: 1263.45
    min: 1198.23
    max: 1312.89
    stddev: 31.23
    unit: Mbps
latency:
  mean: 1.45
  median: 1.42
  min: 0.89
  max: 2.34
  p50: 1.42
  p90: 1.98
  p95: 2.12
  p99: 2.28
  stddev: 0.32
  unit: ms
```

#### Hole-Punch Test Output (from dialer)

```yaml
latency:
  handshake_plus_one_rtt: 234.56
  ping_rtt: 1.23
  unit: ms
```

### Extraction Process

The test runner:

1. **Captures container logs**:
   ```bash
   DIALER_LOGS=$(docker compose -f compose.yaml logs dialer)
   ```

2. **Extracts YAML** (filtering docker-compose prefixes):
   ```bash
   DIALER_YAML=$(echo "$DIALER_LOGS" | \
     grep -E "dialer.*\\| (upload:|download:|latency:)" | \
     sed 's/^.*| //')
   ```

3. **Appends to result**:
   ```bash
   cat >> results.yaml <<EOF
   - name: ${TEST_NAME}
     ...
     status: pass
     duration: ${TEST_DURATION}s
   ${DIALER_YAML}
   EOF
   ```

---

## Usage

### Dashboard Generation

Results are used to generate HTML dashboards:

```bash
# Perf dashboard with charts
perf/lib/generate-dashboard.sh "$TEST_PASS_DIR"

# Transport results table
transport/lib/generate-dashboard.sh "$TEST_PASS_DIR"

# Hole-punch results table
hole-punch/lib/generate-dashboard.sh "$TEST_PASS_DIR"
```

### Analyzing Results

```bash
# List failed tests
yq eval '.tests[] | select(.status == "fail") | .name' results.yaml

# Get pass rate
yq eval '.summary.passed / .summary.total * 100' results.yaml

# Extract specific measurement
yq eval '.tests[] | select(.name == "rust-v0.56 x rust-v0.56 (tcp, noise, yamux)") | .upload.bandwidth.mean' results.yaml

# Compare baseline vs implementation
yq eval '.baselines[] | select(.name == "iperf x iperf (tcp)") | .upload.bandwidth.mean' results.yaml
yq eval '.tests[] | select(.name == "rust-v0.56 x rust-v0.56 (tcp, noise, yamux)") | .upload.bandwidth.mean' results.yaml
```

### CI/CD Integration

Results can be parsed for CI/CD pipelines:

```bash
# Check if any tests failed
FAILED=$(yq eval '.summary.failed' results.yaml)
if [ "$FAILED" -gt 0 ]; then
  echo "✗ $FAILED tests failed"
  exit 1
else
  echo "✓ All tests passed"
fi

# Check performance regression
BASELINE_BW=$(yq eval '.baselines[] | select(.name == "iperf x iperf (tcp)") | .upload.bandwidth.mean' results.yaml)
TEST_BW=$(yq eval '.tests[] | select(.name == "rust-v0.56 x rust-v0.56 (tcp, noise, yamux)") | .upload.bandwidth.mean' results.yaml)

# Calculate percentage of baseline
PERCENTAGE=$(echo "scale=2; $TEST_BW / $BASELINE_BW * 100" | bc)
echo "Performance: $PERCENTAGE% of baseline"
```

---

## Individual Test Results

In addition to the aggregated `results.yaml`, each test has an individual result file:

**Location**: `$TEST_PASS_DIR/results/<test-name>.yaml`

**Format**: Same structure as test entry in results.yaml but as standalone document

**Purpose**:
- Easier per-test analysis
- Parallel result writing without locking
- Individual test debugging

---

## Related Files

- **Generation**: `perf/lib/run-single-test.sh:207`, `transport/lib/run-single-test.sh`, `hole-punch/lib/run-single-test.sh`
- **Aggregation**: `perf/run.sh:671-785`, `transport/run.sh`, `hole-punch/run.sh`
- **Test Matrix**: `test-matrix.yaml` (defines tests to execute)
- **Dashboard**: `perf/lib/generate-dashboard.sh`, `transport/lib/generate-dashboard.sh`, `hole-punch/lib/generate-dashboard.sh`

---

## See Also

- **[docs/test-matrix-schema.md](test-matrix-schema.md)** - test-matrix.yaml schema specification
- **[docs/images-yaml-schema.md](images-yaml-schema.md)** - images.yaml schema specification
- **[docs/inputs-schema.md](inputs-schema.md)** - inputs.yaml schema specification
- **[docs/overall-flow.md](overall-flow.md)** - Test execution flow overview
