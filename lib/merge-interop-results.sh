#!/usr/bin/env bash
# Merges test results from all three test suites (transport, hole-punch, perf)
# into a single combined YAML file for the unified website dashboard.
#
# Usage: merge-interop-results.sh <transport-dir> <hole-punch-dir> <perf-dir> <output-file> [workflow-run-url]
#
# Arguments:
#   transport-dir   - Directory containing transport test results (results.yaml)
#   hole-punch-dir  - Directory containing hole-punch test results (results.yaml)
#   perf-dir        - Directory containing perf test results (results.yaml)
#   output-file     - Output file path (default: results/daily-full-interop.yml)
#   workflow-run-url - Optional GitHub Actions workflow run URL

set -euo pipefail

# Parse arguments
TRANSPORT_DIR="${1:-}"
HOLE_PUNCH_DIR="${2:-}"
PERF_DIR="${3:-}"
OUTPUT_FILE="${4:-results/daily-full-interop.yml}"
WORKFLOW_RUN_URL="${5:-}"

# Create output directory
OUTPUT_DIR=$(dirname "$OUTPUT_FILE")
mkdir -p "$OUTPUT_DIR"

# Helper function to check if a results file exists and is valid
check_results_file() {
    local dir="$1"
    local file="$dir/results.yaml"

    if [ -z "$dir" ] || [ ! -d "$dir" ]; then
        return 1
    fi

    if [ ! -f "$file" ]; then
        return 1
    fi

    # Check if file has content
    if [ ! -s "$file" ]; then
        return 1
    fi

    return 0
}

# Helper function to extract YAML section with yq
extract_section() {
    local file="$1"
    local query="$2"
    local default="${3:-null}"

    if [ -f "$file" ]; then
        yq eval "$query" "$file" 2>/dev/null || echo "$default"
    else
        echo "$default"
    fi
}

# Generate timestamp in ISO 8601 format
GENERATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

echo "Merging interop results..."
echo "  Transport dir: ${TRANSPORT_DIR:-<not provided>}"
echo "  Hole-punch dir: ${HOLE_PUNCH_DIR:-<not provided>}"
echo "  Perf dir: ${PERF_DIR:-<not provided>}"
echo "  Output: $OUTPUT_FILE"
echo "  Timestamp: $GENERATED_AT"

# Start building the combined YAML
cat > "$OUTPUT_FILE" << EOF
# Combined Interoperability Test Results
# Generated automatically by the daily-full-interop workflow
# Do not edit this file manually

generated-at: "$GENERATED_AT"
workflow-run: "${WORKFLOW_RUN_URL:-null}"

EOF

# Process Transport results
echo "" >> "$OUTPUT_FILE"
if check_results_file "$TRANSPORT_DIR"; then
    echo "  Found transport results"
    TRANSPORT_RESULTS="$TRANSPORT_DIR/results.yaml"

    # Extract metadata
    TEST_PASS=$(extract_section "$TRANSPORT_RESULTS" '.metadata.testPass // ""')
    STARTED_AT=$(extract_section "$TRANSPORT_RESULTS" '.metadata.startedAt // ""')
    COMPLETED_AT=$(extract_section "$TRANSPORT_RESULTS" '.metadata.completedAt // ""')
    DURATION=$(extract_section "$TRANSPORT_RESULTS" '.metadata.duration // ""')

    # Extract summary counts
    TOTAL=$(extract_section "$TRANSPORT_RESULTS" '.summary.total // 0')
    PASSED=$(extract_section "$TRANSPORT_RESULTS" '.summary.passed // 0')
    FAILED=$(extract_section "$TRANSPORT_RESULTS" '.summary.failed // 0')

    cat >> "$OUTPUT_FILE" << EOF
transport:
  metadata:
    test-pass: "$TEST_PASS"
    started-at: "$STARTED_AT"
    completed-at: "$COMPLETED_AT"
    duration: "$DURATION"
  summary:
    total: $TOTAL
    passed: $PASSED
    failed: $FAILED
  results:
EOF

    # Extract individual test results from .tests[] (correct source field)
    TRANSPORT_TEST_COUNT=$(yq eval '.tests | length // 0' "$TRANSPORT_RESULTS" 2>/dev/null || echo "0")
    if [ "$TRANSPORT_TEST_COUNT" -gt 0 ]; then
        # Transform each test to the output format as a proper YAML array
        yq '.tests | map({
            "name": .name,
            "dialer": .dialer,
            "listener": .listener,
            "transport": .transport,
            "secure-channel": (.secureChannel // null),
            "muxer": (.muxer // null),
            "status": .status
        })' "$TRANSPORT_RESULTS" 2>/dev/null | sed 's/^/    /' >> "$OUTPUT_FILE"
    else
        echo "    []" >> "$OUTPUT_FILE"
    fi

else
    echo "  No transport results found"
    echo "transport: null" >> "$OUTPUT_FILE"
fi

# Process Hole-punch results
echo "" >> "$OUTPUT_FILE"
if check_results_file "$HOLE_PUNCH_DIR"; then
    echo "  Found hole-punch results"
    HOLE_PUNCH_RESULTS="$HOLE_PUNCH_DIR/results.yaml"

    # Extract metadata
    TEST_PASS=$(extract_section "$HOLE_PUNCH_RESULTS" '.metadata.testPass // ""')
    STARTED_AT=$(extract_section "$HOLE_PUNCH_RESULTS" '.metadata.startedAt // ""')
    COMPLETED_AT=$(extract_section "$HOLE_PUNCH_RESULTS" '.metadata.completedAt // ""')
    DURATION=$(extract_section "$HOLE_PUNCH_RESULTS" '.metadata.duration // ""')

    # Extract summary counts
    TOTAL=$(extract_section "$HOLE_PUNCH_RESULTS" '.summary.total // 0')
    PASSED=$(extract_section "$HOLE_PUNCH_RESULTS" '.summary.passed // 0')
    FAILED=$(extract_section "$HOLE_PUNCH_RESULTS" '.summary.failed // 0')

    cat >> "$OUTPUT_FILE" << EOF
hole-punch:
  metadata:
    test-pass: "$TEST_PASS"
    started-at: "$STARTED_AT"
    completed-at: "$COMPLETED_AT"
    duration: "$DURATION"
  summary:
    total: $TOTAL
    passed: $PASSED
    failed: $FAILED
  results:
EOF

    # Extract individual test results from .tests[] (correct source field)
    HP_TEST_COUNT=$(yq eval '.tests | length // 0' "$HOLE_PUNCH_RESULTS" 2>/dev/null || echo "0")
    if [ "$HP_TEST_COUNT" -gt 0 ]; then
        # Transform each test to the output format as a proper YAML array
        yq '.tests | map({
            "name": .name,
            "dialer": .dialer,
            "listener": .listener,
            "relay": (.relay // "unknown"),
            "dialer-router": (.dialerRouter // "unknown"),
            "listener-router": (.listenerRouter // "unknown"),
            "transport": .transport,
            "status": .status
        })' "$HOLE_PUNCH_RESULTS" 2>/dev/null | sed 's/^/    /' >> "$OUTPUT_FILE"
    else
        echo "    []" >> "$OUTPUT_FILE"
    fi

else
    echo "  No hole-punch results found"
    echo "hole-punch: null" >> "$OUTPUT_FILE"
fi

# Process Perf results
echo "" >> "$OUTPUT_FILE"
if check_results_file "$PERF_DIR"; then
    echo "  Found perf results"
    PERF_RESULTS="$PERF_DIR/results.yaml"

    # Extract metadata
    TEST_PASS=$(extract_section "$PERF_RESULTS" '.metadata.testPass // ""')
    STARTED_AT=$(extract_section "$PERF_RESULTS" '.metadata.startedAt // ""')
    COMPLETED_AT=$(extract_section "$PERF_RESULTS" '.metadata.completedAt // ""')
    DURATION=$(extract_section "$PERF_RESULTS" '.metadata.duration // ""')

    # Extract summary counts from both baseline and main results
    BASELINE_TOTAL=$(extract_section "$PERF_RESULTS" '.summary.baselineTotal // 0')
    BASELINE_PASSED=$(extract_section "$PERF_RESULTS" '.summary.baselinePassed // 0')
    BASELINE_FAILED=$(extract_section "$PERF_RESULTS" '.summary.baselineFailed // 0')
    MAIN_TOTAL=$(extract_section "$PERF_RESULTS" '.summary.total // 0')
    MAIN_PASSED=$(extract_section "$PERF_RESULTS" '.summary.passed // 0')
    MAIN_FAILED=$(extract_section "$PERF_RESULTS" '.summary.failed // 0')

    cat >> "$OUTPUT_FILE" << EOF
perf:
  metadata:
    test-pass: "$TEST_PASS"
    started-at: "$STARTED_AT"
    completed-at: "$COMPLETED_AT"
    duration: "$DURATION"
  summary:
    baseline-total: $BASELINE_TOTAL
    baseline-passed: $BASELINE_PASSED
    baseline-failed: $BASELINE_FAILED
    main-total: $MAIN_TOTAL
    main-passed: $MAIN_PASSED
    main-failed: $MAIN_FAILED
EOF

    # Count baseline and main test results
    BASELINE_COUNT=$(yq eval '.baselineResults | length // 0' "$PERF_RESULTS" 2>/dev/null || echo "0")
    PERF_TEST_COUNT=$(yq eval '.testResults | length // 0' "$PERF_RESULTS" 2>/dev/null || echo "0")

    # Add baselines section
    echo "  baselines:" >> "$OUTPUT_FILE"

    # Extract baseline results (from .baselineResults in source) as proper YAML array
    if [ "$BASELINE_COUNT" -gt 0 ]; then
        yq '.baselineResults | map({
            "name": .name,
            "dialer": .dialer,
            "listener": .listener,
            "transport": .transport,
            "status": .status,
            "upload-throughput": (.upload.median // null),
            "download-throughput": (.download.median // null)
        })' "$PERF_RESULTS" 2>/dev/null | sed 's/^/    /' >> "$OUTPUT_FILE"
    else
        echo "    []" >> "$OUTPUT_FILE"
    fi

    # Add results section (main test results)
    echo "  results:" >> "$OUTPUT_FILE"

    # Extract main test results (from .testResults in source) as proper YAML array
    if [ "$PERF_TEST_COUNT" -gt 0 ]; then
        yq '.testResults | map({
            "name": .name,
            "dialer": .dialer,
            "listener": .listener,
            "transport": .transport,
            "secure-channel": (.secureChannel // null),
            "muxer": (.muxer // null),
            "status": .status,
            "upload": {
                "min": (.upload.min // null),
                "q1": (.upload.q1 // null),
                "median": (.upload.median // null),
                "q3": (.upload.q3 // null),
                "max": (.upload.max // null)
            },
            "download": {
                "min": (.download.min // null),
                "q1": (.download.q1 // null),
                "median": (.download.median // null),
                "q3": (.download.q3 // null),
                "max": (.download.max // null)
            },
            "latency": {
                "min": (.latency.min // null),
                "q1": (.latency.q1 // null),
                "median": (.latency.median // null),
                "q3": (.latency.q3 // null),
                "max": (.latency.max // null)
            }
        })' "$PERF_RESULTS" 2>/dev/null | sed 's/^/    /' >> "$OUTPUT_FILE"
    else
        echo "    []" >> "$OUTPUT_FILE"
    fi

else
    echo "  No perf results found"
    echo "perf: null" >> "$OUTPUT_FILE"
fi

# Add box plot references
echo "" >> "$OUTPUT_FILE"
cat >> "$OUTPUT_FILE" << EOF
box-plots:
EOF

# Copy box plot files if they exist
BOX_PLOTS_FOUND=false
if [ -n "$PERF_DIR" ] && [ -d "$PERF_DIR" ]; then
    echo "  Looking for box plots in: $PERF_DIR"
    ls -la "$PERF_DIR"/*.png 2>/dev/null || echo "  No PNG files found in PERF_DIR"

    for plot_type in upload download latency; do
        PLOT_FOUND=false
        # Check for both naming conventions
        for src_file in "$PERF_DIR/boxplot-${plot_type}.png" "$PERF_DIR/${plot_type}_boxplot.png"; do
            if [ -f "$src_file" ]; then
                dest_file="$OUTPUT_DIR/boxplot-${plot_type}.png"
                cp "$src_file" "$dest_file"
                echo "  ${plot_type}: \"boxplot-${plot_type}.png\"" >> "$OUTPUT_FILE"
                echo "  Copied: $src_file -> $dest_file"
                BOX_PLOTS_FOUND=true
                PLOT_FOUND=true
                break
            fi
        done
        if [ "$PLOT_FOUND" = false ]; then
            echo "  ${plot_type}: null" >> "$OUTPUT_FILE"
        fi
    done

    # List what's in output dir
    echo "  Files in $OUTPUT_DIR:"
    ls -la "$OUTPUT_DIR"/*.png 2>/dev/null || echo "  No PNG files in output dir"
else
    echo "  upload: null" >> "$OUTPUT_FILE"
    echo "  download: null" >> "$OUTPUT_FILE"
    echo "  latency: null" >> "$OUTPUT_FILE"
    echo "  No perf directory provided for box plots"
fi

echo ""
echo "Combined results written to: $OUTPUT_FILE"

# Validate the output YAML
if command -v yq &> /dev/null; then
    if yq eval '.' "$OUTPUT_FILE" > /dev/null 2>&1; then
        echo "YAML validation: OK"
    else
        echo "Warning: Generated YAML may have syntax issues"
        exit 1
    fi
fi
