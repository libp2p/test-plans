#!/usr/bin/env bash
# Merges test results from all three test suites (transport, hole-punch, perf)
# into a single combined YAML file for the unified website dashboard.
#
# Usage: merge-interop-results.sh <transport-dir> <hole-punch-dir> <perf-dir> <output-file> [workflow-run-url]
#
# Arguments:
#   transport-dir   - Directory containing transport test results (results.yaml)
#   hole-punch-dir  - Directory containing hole-punch test results (results.yaml)
#   perf-dir        - Directory containing perf test results (results.yaml)
#   output-file     - Output file path (default: results/daily-full-interop.yml)
#   workflow-run-url - Optional GitHub Actions workflow run URL

set -euo pipefail

# Parse arguments
TRANSPORT_DIR="${1:-}"
HOLE_PUNCH_DIR="${2:-}"
PERF_DIR="${3:-}"
OUTPUT_FILE="${4:-results/daily-full-interop.yml}"
WORKFLOW_RUN_URL="${5:-}"

# Create output directory
mkdir -p "$(dirname "$OUTPUT_FILE")"

# Helper function to check if a results file exists and is valid
check_results_file() {
    local dir="$1"
    local file="$dir/results.yaml"

    if [ -z "$dir" ] || [ ! -d "$dir" ]; then
        return 1
    fi

    if [ ! -f "$file" ]; then
        return 1
    fi

    # Check if file has content
    if [ ! -s "$file" ]; then
        return 1
    fi

    return 0
}

# Helper function to extract YAML section with yq
extract_section() {
    local file="$1"
    local query="$2"
    local default="${3:-null}"

    if [ -f "$file" ]; then
        yq eval "$query" "$file" 2>/dev/null || echo "$default"
    else
        echo "$default"
    fi
}

# Generate timestamp in ISO 8601 format
GENERATED_AT=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

echo "Merging interop results..."
echo "  Transport dir: ${TRANSPORT_DIR:-<not provided>}"
echo "  Hole-punch dir: ${HOLE_PUNCH_DIR:-<not provided>}"
echo "  Perf dir: ${PERF_DIR:-<not provided>}"
echo "  Output: $OUTPUT_FILE"
echo "  Timestamp: $GENERATED_AT"

# Start building the combined YAML
cat > "$OUTPUT_FILE" << EOF
# Combined Interoperability Test Results
# Generated automatically by the daily-full-interop workflow
# Do not edit this file manually

generatedAt: "$GENERATED_AT"
workflowRun: "${WORKFLOW_RUN_URL:-null}"

EOF

# Process Transport results
echo "" >> "$OUTPUT_FILE"
if check_results_file "$TRANSPORT_DIR"; then
    echo "  Found transport results"
    TRANSPORT_RESULTS="$TRANSPORT_DIR/results.yaml"

    # Extract metadata
    TEST_PASS=$(extract_section "$TRANSPORT_RESULTS" '.metadata.testPass // ""')
    STARTED_AT=$(extract_section "$TRANSPORT_RESULTS" '.metadata.startedAt // ""')
    COMPLETED_AT=$(extract_section "$TRANSPORT_RESULTS" '.metadata.completedAt // ""')
    DURATION=$(extract_section "$TRANSPORT_RESULTS" '.metadata.duration // ""')

    # Extract summary counts
    TOTAL=$(extract_section "$TRANSPORT_RESULTS" '.summary.total // 0')
    PASSED=$(extract_section "$TRANSPORT_RESULTS" '.summary.passed // 0')
    FAILED=$(extract_section "$TRANSPORT_RESULTS" '.summary.failed // 0')

    cat >> "$OUTPUT_FILE" << EOF
transport:
  metadata:
    testPass: "$TEST_PASS"
    startedAt: "$STARTED_AT"
    completedAt: "$COMPLETED_AT"
    duration: "$DURATION"
  summary:
    total: $TOTAL
    passed: $PASSED
    failed: $FAILED
  tests:
EOF

    # Extract individual test results - use yq to output each test as a YAML list item
    yq eval '.results[] | "    - name: \"" + .id + "\"\n      dialer: \"" + .dialer.id + "\"\n      listener: \"" + .listener.id + "\"\n      transport: \"" + .transport + "\"\n      secureChannel: \"" + (.secureChannel // "null") + "\"\n      muxer: \"" + (.muxer // "null") + "\"\n      status: \"" + .outcome + "\""' "$TRANSPORT_RESULTS" 2>/dev/null >> "$OUTPUT_FILE" || echo "    []" >> "$OUTPUT_FILE"

else
    echo "  No transport results found"
    echo "transport: null" >> "$OUTPUT_FILE"
fi

# Process Hole-punch results
echo "" >> "$OUTPUT_FILE"
if check_results_file "$HOLE_PUNCH_DIR"; then
    echo "  Found hole-punch results"
    HOLE_PUNCH_RESULTS="$HOLE_PUNCH_DIR/results.yaml"

    # Extract metadata
    TEST_PASS=$(extract_section "$HOLE_PUNCH_RESULTS" '.metadata.testPass // ""')
    STARTED_AT=$(extract_section "$HOLE_PUNCH_RESULTS" '.metadata.startedAt // ""')
    COMPLETED_AT=$(extract_section "$HOLE_PUNCH_RESULTS" '.metadata.completedAt // ""')
    DURATION=$(extract_section "$HOLE_PUNCH_RESULTS" '.metadata.duration // ""')

    # Extract summary counts
    TOTAL=$(extract_section "$HOLE_PUNCH_RESULTS" '.summary.total // 0')
    PASSED=$(extract_section "$HOLE_PUNCH_RESULTS" '.summary.passed // 0')
    FAILED=$(extract_section "$HOLE_PUNCH_RESULTS" '.summary.failed // 0')

    cat >> "$OUTPUT_FILE" << EOF
holePunch:
  metadata:
    testPass: "$TEST_PASS"
    startedAt: "$STARTED_AT"
    completedAt: "$COMPLETED_AT"
    duration: "$DURATION"
  summary:
    total: $TOTAL
    passed: $PASSED
    failed: $FAILED
  tests:
EOF

    # Extract individual test results including relay information
    yq eval '.results[] | "    - name: \"" + .id + "\"\n      dialer: \"" + .dialer.id + "\"\n      listener: \"" + .listener.id + "\"\n      relay: \"" + (.relay.id // "unknown") + "\"\n      router: \"" + (.router.id // "unknown") + "\"\n      transport: \"" + .transport + "\"\n      status: \"" + .outcome + "\""' "$HOLE_PUNCH_RESULTS" 2>/dev/null >> "$OUTPUT_FILE" || echo "    []" >> "$OUTPUT_FILE"

else
    echo "  No hole-punch results found"
    echo "holePunch: null" >> "$OUTPUT_FILE"
fi

# Process Perf results
echo "" >> "$OUTPUT_FILE"
if check_results_file "$PERF_DIR"; then
    echo "  Found perf results"
    PERF_RESULTS="$PERF_DIR/results.yaml"

    # Extract metadata
    TEST_PASS=$(extract_section "$PERF_RESULTS" '.metadata.testPass // ""')
    STARTED_AT=$(extract_section "$PERF_RESULTS" '.metadata.startedAt // ""')
    COMPLETED_AT=$(extract_section "$PERF_RESULTS" '.metadata.completedAt // ""')
    DURATION=$(extract_section "$PERF_RESULTS" '.metadata.duration // ""')

    # Extract summary counts from both baseline and main results
    BASELINE_TOTAL=$(extract_section "$PERF_RESULTS" '.summary.baselineTotal // 0')
    BASELINE_PASSED=$(extract_section "$PERF_RESULTS" '.summary.baselinePassed // 0')
    BASELINE_FAILED=$(extract_section "$PERF_RESULTS" '.summary.baselineFailed // 0')
    MAIN_TOTAL=$(extract_section "$PERF_RESULTS" '.summary.total // 0')
    MAIN_PASSED=$(extract_section "$PERF_RESULTS" '.summary.passed // 0')
    MAIN_FAILED=$(extract_section "$PERF_RESULTS" '.summary.failed // 0')

    cat >> "$OUTPUT_FILE" << EOF
perf:
  metadata:
    testPass: "$TEST_PASS"
    startedAt: "$STARTED_AT"
    completedAt: "$COMPLETED_AT"
    duration: "$DURATION"
  summary:
    baselineTotal: $BASELINE_TOTAL
    baselinePassed: $BASELINE_PASSED
    baselineFailed: $BASELINE_FAILED
    mainTotal: $MAIN_TOTAL
    mainPassed: $MAIN_PASSED
    mainFailed: $MAIN_FAILED
  baselineResults:
EOF

    # Extract baseline results
    yq eval '.baselineResults[] | "    - name: \"" + .id + "\"\n      dialer: \"" + .dialer.id + "\"\n      listener: \"" + .listener.id + "\"\n      transport: \"" + .transport + "\"\n      status: \"" + .outcome + "\"\n      uploadThroughput: " + (.uploadThroughput.median // "null" | tostring) + "\n      downloadThroughput: " + (.downloadThroughput.median // "null" | tostring)' "$PERF_RESULTS" 2>/dev/null >> "$OUTPUT_FILE" || echo "    []" >> "$OUTPUT_FILE"

    cat >> "$OUTPUT_FILE" << EOF
  testResults:
EOF

    # Extract main test results with performance metrics
    yq eval '.results[] | "    - name: \"" + .id + "\"\n      dialer: \"" + .dialer.id + "\"\n      listener: \"" + .listener.id + "\"\n      transport: \"" + .transport + "\"\n      secureChannel: \"" + (.secureChannel // "null") + "\"\n      muxer: \"" + (.muxer // "null") + "\"\n      status: \"" + .outcome + "\"\n      upload:\n        min: " + (.uploadThroughput.min // "null" | tostring) + "\n        q1: " + (.uploadThroughput.q1 // "null" | tostring) + "\n        median: " + (.uploadThroughput.median // "null" | tostring) + "\n        q3: " + (.uploadThroughput.q3 // "null" | tostring) + "\n        max: " + (.uploadThroughput.max // "null" | tostring) + "\n      download:\n        min: " + (.downloadThroughput.min // "null" | tostring) + "\n        q1: " + (.downloadThroughput.q1 // "null" | tostring) + "\n        median: " + (.downloadThroughput.median // "null" | tostring) + "\n        q3: " + (.downloadThroughput.q3 // "null" | tostring) + "\n        max: " + (.downloadThroughput.max // "null" | tostring) + "\n      latency:\n        min: " + (.latency.min // "null" | tostring) + "\n        q1: " + (.latency.q1 // "null" | tostring) + "\n        median: " + (.latency.median // "null" | tostring) + "\n        q3: " + (.latency.q3 // "null" | tostring) + "\n        max: " + (.latency.max // "null" | tostring)' "$PERF_RESULTS" 2>/dev/null >> "$OUTPUT_FILE" || echo "    []" >> "$OUTPUT_FILE"

else
    echo "  No perf results found"
    echo "perf: null" >> "$OUTPUT_FILE"
fi

# Add box plot references
echo "" >> "$OUTPUT_FILE"
cat >> "$OUTPUT_FILE" << EOF
boxPlots:
EOF

# Copy box plot files if they exist
BOX_PLOTS_FOUND=false
if [ -n "$PERF_DIR" ] && [ -d "$PERF_DIR" ]; then
    OUTPUT_DIR=$(dirname "$OUTPUT_FILE")

    for plot_type in upload download latency; do
        # Check for both naming conventions
        for src_file in "$PERF_DIR/boxplot-${plot_type}.png" "$PERF_DIR/${plot_type}_boxplot.png"; do
            if [ -f "$src_file" ]; then
                dest_file="$OUTPUT_DIR/boxplot-${plot_type}.png"
                cp "$src_file" "$dest_file"
                echo "  ${plot_type}: \"boxplot-${plot_type}.png\"" >> "$OUTPUT_FILE"
                echo "  Copied $src_file -> $dest_file"
                BOX_PLOTS_FOUND=true
                break
            fi
        done
    done
fi

if [ "$BOX_PLOTS_FOUND" = false ]; then
    echo "  upload: null" >> "$OUTPUT_FILE"
    echo "  download: null" >> "$OUTPUT_FILE"
    echo "  latency: null" >> "$OUTPUT_FILE"
    echo "  No box plots found"
fi

echo ""
echo "Combined results written to: $OUTPUT_FILE"

# Validate the output YAML
if command -v yq &> /dev/null; then
    if yq eval '.' "$OUTPUT_FILE" > /dev/null 2>&1; then
        echo "YAML validation: OK"
    else
        echo "Warning: Generated YAML may have syntax issues"
        exit 1
    fi
fi
