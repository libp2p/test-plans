name: go-libp2p Transport Interop Tests

on:
  workflow_dispatch:
    inputs:
      versions:
        description: 'Comma-separated list of go-libp2p versions (e.g. v0.42,v0.44)'
        required: false
        default: ''
        type: string

  pull_request:
    paths:
      - "transport-interop/impl/go/**"

jobs:
  run-go-transport-interop:
    runs-on: [self-hosted, linux, x64, ephemeral]
    steps:
      - uses: actions/checkout@v4

      # Build test-filter by scanning the transport-interop/impl/go/ subdirs
      - name: Determine test-filter from manual input
        id: build-test-filter
        shell: bash
        run: |
          INPUT_VERSIONS="${{ inputs.versions }}"
          
          if [ -n "$INPUT_VERSIONS" ]; then
            # Use provided versions: v0.42,v0.44 â†’ go-v0.42|go-v0.44
            TEST_FILTER=$(echo "$INPUT_VERSIONS" | tr ',' '\n' | sed 's/^/go-/g' | paste -sd '|' -)
          else
            # No input: scan all subdirs in transport-interop/impl/go/
            VERSIONS=$(ls -1 transport-interop/impl/go/ | grep '^v[0-9]' | sort | uniq)
            if [ -n "$VERSIONS" ]; then
              TEST_FILTER=$(echo "$VERSIONS" | sed 's/^/go-/g' | paste -sd '|' -)
            else
              TEST_FILTER=""
            fi
          fi
          
          echo "Setting: test-filter=$TEST_FILTER"
          echo "test-filter=$TEST_FILTER" >> $GITHUB_OUTPUT

      # Build test-ignore from transport-interop/impl/go/test-ignore.txt if it exists
      - name: Read test-ignore file
        id: test-ignore
        run: |
          if [ -f "transport-interop/impl/go/test-ignore.txt" ]; then
            TEST_IGNORE=$(cat transport-interop/impl/go/test-ignore.txt)
            echo "Setting: test-ignore=$TEST_IGNORE"
            echo "test-ignore=$TEST_IGNORE" >> $GITHUB_OUTPUT
          else
            echo "Setting: test-ignore=''"
            echo "test-ignore=" >> $GITHUB_OUTPUT
          fi

      # Run the transport interop tests
      - uses: ./.github/actions/run-transport-interop-test
        with:
          worker-count: 8
          cache-dir: /srv/cache
          test-filter: ${{ steps.build-test-filter.outputs.test-filter }}
          test-ignore: ${{ steps.test-ignore.outputs.test-ignore }}
          test-root: "transport-interop/impl/go"
