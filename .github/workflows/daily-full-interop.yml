name: Daily Full Interoperability Tests

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:
    inputs:
      # Transport parameters
      transport-test-select:
        description: '[Transport] Select specific tests (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      transport-test-ignore:
        description: '[Transport] Ignore specific tests (pipe-separated substrings)'
        required: false
        default: '~failing'
        type: string
      transport-force-matrix-rebuild:
        description: '[Transport] Force test matrix regeneration'
        required: false
        default: false
        type: boolean
      transport-force-image-rebuild:
        description: '[Transport] Force Docker image rebuilds'
        required: false
        default: false
        type: boolean
      transport-debug:
        description: '[Transport] Enable debug mode'
        required: false
        default: false
        type: boolean
      # Hole-punch parameters
      hole-punch-test-select:
        description: '[Hole-punch] Select specific tests (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      hole-punch-test-ignore:
        description: '[Hole-punch] Ignore specific tests (pipe-separated substrings)'
        required: false
        default: '~failing'
        type: string
      hole-punch-relay-select:
        description: '[Hole-punch] Select specific relays (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      hole-punch-relay-ignore:
        description: '[Hole-punch] Ignore specific relays (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      hole-punch-router-select:
        description: '[Hole-punch] Select specific routers (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      hole-punch-router-ignore:
        description: '[Hole-punch] Ignore specific routers (pipe-separated substrings)'
        required: false
        default: ''
        type: string
      hole-punch-force-matrix-rebuild:
        description: '[Hole-punch] Force test matrix regeneration'
        required: false
        default: false
        type: boolean
      hole-punch-force-image-rebuild:
        description: '[Hole-punch] Force Docker image rebuilds'
        required: false
        default: false
        type: boolean
      hole-punch-debug:
        description: '[Hole-punch] Enable debug mode'
        required: false
        default: false
        type: boolean

jobs:
  check-transport-changes:
    if: github.event_name != 'workflow_dispatch'
    runs-on: [self-hosted, linux, x64, ephemeral]
    outputs:
      has-changes: ${{ steps.check.outputs.has-changes }}
      impls-yaml-changed: ${{ steps.check.outputs.impls-yaml-changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check transport changes in last 24 hours
        id: check
        shell: bash
        run: |
          # Check if anything in transport/ changed in last 24 hours
          CHANGES=$(git log --oneline --since="24 hours ago" -- "transport/**" | wc -l)

          if [ "$CHANGES" -eq 0 ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "impls-yaml-changed=false" >> $GITHUB_OUTPUT
            echo "→ No changes in transport/ in last 24 hours, skipping tests"
            exit 0
          fi

          echo "has-changes=true" >> $GITHUB_OUTPUT

          # Check specifically if impls.yaml changed in last 24 hours
          IMPLS_CHANGES=$(git log --oneline --since="24 hours ago" -- "transport/impls.yaml" | wc -l)

          if [ "$IMPLS_CHANGES" -gt 0 ]; then
            echo "impls-yaml-changed=true" >> $GITHUB_OUTPUT
            echo "→ transport/impls.yaml changed in last 24h, will force matrix rebuild"
          else
            echo "impls-yaml-changed=false" >> $GITHUB_OUTPUT
            echo "→ Other transport files changed, using cached matrix if available"
          fi

  resolve-transport-parameters:
    runs-on: [self-hosted, linux, x64, ephemeral]
    needs: check-transport-changes
    if: always() && (needs.check-transport-changes.result == 'success' || needs.check-transport-changes.result == 'skipped')
    outputs:
      test-select: ${{ steps.resolve.outputs.test-select }}
      test-ignore: ${{ steps.resolve.outputs.test-ignore }}
      force-matrix-rebuild: ${{ steps.resolve.outputs.force-matrix-rebuild }}
      force-image-rebuild: ${{ steps.resolve.outputs.force-image-rebuild }}
      debug: ${{ steps.resolve.outputs.debug }}
      should-run-tests: ${{ steps.resolve.outputs.should-run-tests }}
    steps:
      - name: Resolve transport parameters
        id: resolve
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use workflow inputs
            echo "test-select=${{ github.event.inputs.transport-test-select }}" >> $GITHUB_OUTPUT
            echo "test-ignore=${{ github.event.inputs.transport-test-ignore }}" >> $GITHUB_OUTPUT
            echo "force-matrix-rebuild=${{ github.event.inputs.transport-force-matrix-rebuild }}" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=${{ github.event.inputs.transport-force-image-rebuild }}" >> $GITHUB_OUTPUT
            echo "debug=${{ github.event.inputs.transport-debug }}" >> $GITHUB_OUTPUT
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
            echo "→ Manual trigger: using workflow inputs for transport"
          elif [ "${{ needs.check-transport-changes.result }}" = "success" ]; then
            # Automatic trigger - use change detection outputs
            echo "test-select=" >> $GITHUB_OUTPUT
            echo "test-ignore=~failing" >> $GITHUB_OUTPUT
            echo "force-matrix-rebuild=${{ needs.check-transport-changes.outputs.impls-yaml-changed }}" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=false" >> $GITHUB_OUTPUT
            echo "debug=false" >> $GITHUB_OUTPUT
            echo "should-run-tests=${{ needs.check-transport-changes.outputs.has-changes }}" >> $GITHUB_OUTPUT
            echo "→ Automatic trigger: using change detection for transport"
          else
            # Check job was skipped or failed - don't run tests
            echo "test-select=" >> $GITHUB_OUTPUT
            echo "test-ignore=~failing" >> $GITHUB_OUTPUT
            echo "force-matrix-rebuild=false" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=false" >> $GITHUB_OUTPUT
            echo "debug=false" >> $GITHUB_OUTPUT
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
            echo "→ Check job skipped/failed: not running tests"
          fi

  check-hole-punch-changes:
    if: github.event_name != 'workflow_dispatch'
    runs-on: [self-hosted, linux, x64, ephemeral]
    outputs:
      has-changes: ${{ steps.check.outputs.has-changes }}
      impls-yaml-changed: ${{ steps.check.outputs.impls-yaml-changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check hole-punch changes in last 24 hours
        id: check
        shell: bash
        run: |
          # Check if anything in hole-punch/ changed in last 24 hours
          CHANGES=$(git log --oneline --since="24 hours ago" -- "hole-punch/**" | wc -l)

          if [ "$CHANGES" -eq 0 ]; then
            echo "has-changes=false" >> $GITHUB_OUTPUT
            echo "impls-yaml-changed=false" >> $GITHUB_OUTPUT
            echo "→ No changes in hole-punch/ in last 24 hours, skipping tests"
            exit 0
          fi

          echo "has-changes=true" >> $GITHUB_OUTPUT

          # Check specifically if impls.yaml changed in last 24 hours
          IMPLS_CHANGES=$(git log --oneline --since="24 hours ago" -- "hole-punch/impls.yaml" | wc -l)

          if [ "$IMPLS_CHANGES" -gt 0 ]; then
            echo "impls-yaml-changed=true" >> $GITHUB_OUTPUT
            echo "→ hole-punch/impls.yaml changed in last 24h, will force matrix rebuild"
          else
            echo "impls-yaml-changed=false" >> $GITHUB_OUTPUT
            echo "→ Other hole-punch files changed, using cached matrix if available"
          fi

  resolve-hole-punch-parameters:
    runs-on: [self-hosted, linux, x64, ephemeral]
    needs: check-hole-punch-changes
    if: always() && (needs.check-hole-punch-changes.result == 'success' || needs.check-hole-punch-changes.result == 'skipped')
    outputs:
      test-select: ${{ steps.resolve.outputs.test-select }}
      test-ignore: ${{ steps.resolve.outputs.test-ignore }}
      relay-select: ${{ steps.resolve.outputs.relay-select }}
      relay-ignore: ${{ steps.resolve.outputs.relay-ignore }}
      router-select: ${{ steps.resolve.outputs.router-select }}
      router-ignore: ${{ steps.resolve.outputs.router-ignore }}
      force-matrix-rebuild: ${{ steps.resolve.outputs.force-matrix-rebuild }}
      force-image-rebuild: ${{ steps.resolve.outputs.force-image-rebuild }}
      debug: ${{ steps.resolve.outputs.debug }}
      should-run-tests: ${{ steps.resolve.outputs.should-run-tests }}
    steps:
      - name: Resolve hole-punch parameters
        id: resolve
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual trigger - use workflow inputs
            echo "test-select=${{ github.event.inputs.hole-punch-test-select }}" >> $GITHUB_OUTPUT
            echo "test-ignore=${{ github.event.inputs.hole-punch-test-ignore }}" >> $GITHUB_OUTPUT
            echo "relay-select=${{ github.event.inputs.hole-punch-relay-select }}" >> $GITHUB_OUTPUT
            echo "relay-ignore=${{ github.event.inputs.hole-punch-relay-ignore }}" >> $GITHUB_OUTPUT
            echo "router-select=${{ github.event.inputs.hole-punch-router-select }}" >> $GITHUB_OUTPUT
            echo "router-ignore=${{ github.event.inputs.hole-punch-router-ignore }}" >> $GITHUB_OUTPUT
            echo "force-matrix-rebuild=${{ github.event.inputs.hole-punch-force-matrix-rebuild }}" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=${{ github.event.inputs.hole-punch-force-image-rebuild }}" >> $GITHUB_OUTPUT
            echo "debug=${{ github.event.inputs.hole-punch-debug }}" >> $GITHUB_OUTPUT
            echo "should-run-tests=true" >> $GITHUB_OUTPUT
            echo "→ Manual trigger: using workflow inputs for hole-punch"
          elif [ "${{ needs.check-hole-punch-changes.result }}" = "success" ]; then
            # Automatic trigger - use change detection outputs
            echo "test-select=" >> $GITHUB_OUTPUT
            echo "test-ignore=~failing" >> $GITHUB_OUTPUT
            echo "relay-select=" >> $GITHUB_OUTPUT
            echo "relay-ignore=" >> $GITHUB_OUTPUT
            echo "router-select=" >> $GITHUB_OUTPUT
            echo "router-ignore=" >> $GITHUB_OUTPUT
            echo "force-matrix-rebuild=${{ needs.check-hole-punch-changes.outputs.impls-yaml-changed }}" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=false" >> $GITHUB_OUTPUT
            echo "debug=false" >> $GITHUB_OUTPUT
            echo "should-run-tests=${{ needs.check-hole-punch-changes.outputs.has-changes }}" >> $GITHUB_OUTPUT
            echo "→ Automatic trigger: using change detection for hole-punch"
          else
            # Check job was skipped or failed - don't run tests
            echo "test-select=" >> $GITHUB_OUTPUT
            echo "test-ignore=~failing" >> $GITHUB_OUTPUT
            echo "relay-select=" >> $GITHUB_OUTPUT
            echo "relay-ignore=" >> $GITHUB_OUTPUT
            echo "router-select=" >> $GITHUB_OUTPUT
            echo "router-ignore=" >> $GITHUB_OUTPUT
            echo "force-matrix-rebuild=false" >> $GITHUB_OUTPUT
            echo "force-image-rebuild=false" >> $GITHUB_OUTPUT
            echo "debug=false" >> $GITHUB_OUTPUT
            echo "should-run-tests=false" >> $GITHUB_OUTPUT
            echo "→ Check job skipped/failed: not running tests"
          fi

  run-transport-full:
    needs: resolve-transport-parameters
    if: github.event_name == 'workflow_dispatch' || needs.resolve-transport-parameters.outputs.should-run-tests
    runs-on: [self-hosted, linux, x64, ephemeral]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run full transport interop tests
        uses: ./.github/actions/run-bash-transport-test
        with:
          test-select: '${{ needs.resolve-transport-parameters.outputs.test-select }}'
          test-ignore: '${{ needs.resolve-transport-parameters.outputs.test-ignore }}'
          cache-dir: /srv/cache
          snapshot: true
          force-matrix-rebuild: ${{ needs.resolve-transport-parameters.outputs.force-matrix-rebuild }}
          force-image-rebuild: ${{ needs.resolve-transport-parameters.outputs.force-image-rebuild }}
          debug: ${{ needs.resolve-transport-parameters.outputs.debug }}

  run-hole-punch-full:
    needs: resolve-hole-punch-parameters
    if: github.event_name == 'workflow_dispatch' || needs.resolve-hole-punch-parameters.outputs.should-run-tests
    runs-on: [self-hosted, linux, x64, ephemeral]
    continue-on-error: true
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run full hole punch interop tests
        uses: ./.github/actions/run-bash-hole-punch-test
        with:
          test-select: '${{ needs.resolve-hole-punch-parameters.outputs.test-select }}'
          test-ignore: '${{ needs.resolve-hole-punch-parameters.outputs.test-ignore }}'
          relay-select: '${{ needs.resolve-hole-punch-parameters.outputs.relay-select }}'
          relay-ignore: '${{ needs.resolve-hole-punch-parameters.outputs.relay-ignore }}'
          router-select: '${{ needs.resolve-hole-punch-parameters.outputs.router-select }}'
          router-ignore: '${{ needs.resolve-hole-punch-parameters.outputs.router-ignore }}'
          cache-dir: /srv/cache
          snapshot: true
          force-matrix-rebuild: ${{ needs.resolve-hole-punch-parameters.outputs.force-matrix-rebuild }}
          force-image-rebuild: ${{ needs.resolve-hole-punch-parameters.outputs.force-image-rebuild }}
          debug: ${{ needs.resolve-hole-punch-parameters.outputs.debug }}

  update-readmes:
    needs: [run-transport-full, run-hole-punch-full]
    if: |
      always() &&
      (needs.run-transport-full.result != 'skipped' ||
       needs.run-hole-punch-full.result != 'skipped')
    runs-on: [self-hosted, linux, x64, ephemeral]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download transport test results
        if: needs.run-transport-full.result != 'skipped'
        uses: actions/download-artifact@v4
        with:
          pattern: transport-test-results-*
          path: /tmp/transport-results
          merge-multiple: true

      - name: Download hole-punch test results
        if: needs.run-hole-punch-full.result != 'skipped'
        uses: actions/download-artifact@v4
        with:
          pattern: hole-punch-test-results-*
          path: /tmp/hole-punch-results
          merge-multiple: true

      - name: Update transport README
        if: needs.run-transport-full.result != 'skipped'
        shell: bash
        run: |
          set -euo pipefail

          # Find results.md file
          RESULTS_MD=$(find /tmp/transport-results -name "results.md" | head -1)

          if [ -z "$RESULTS_MD" ]; then
            echo "Error: Could not find transport results.md"
            exit 1
          fi

          echo "→ Found transport results: $RESULTS_MD"

          # Update README using script
          bash scripts/update-readme-results.sh transport/README.md "$RESULTS_MD"

      - name: Update hole-punch README
        if: needs.run-hole-punch-full.result != 'skipped'
        shell: bash
        run: |
          set -euo pipefail

          # Find results.md file
          RESULTS_MD=$(find /tmp/hole-punch-results -name "results.md" | head -1)

          if [ -z "$RESULTS_MD" ]; then
            echo "Error: Could not find hole-punch results.md"
            exit 1
          fi

          echo "→ Found hole-punch results: $RESULTS_MD"

          # Update README using script
          bash scripts/update-readme-results.sh hole-punch/README.md "$RESULTS_MD"

      - name: Commit and push changes
        shell: bash
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if there are changes
          if git diff --quiet transport/README.md hole-punch/README.md 2>/dev/null; then
            echo "→ No changes to commit"
            exit 0
          fi

          git add transport/README.md hole-punch/README.md 2>/dev/null || true

          # Only commit if there are staged changes
          if git diff --cached --quiet 2>/dev/null; then
            echo "→ No staged changes to commit"
            exit 0
          fi

          git commit -m "chore: update test results [skip ci]" \
                     -m "Updated test results from daily full interoperability test run." \
                     -m "Co-authored-by: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"

          git push

          echo "→ Changes committed and pushed"
