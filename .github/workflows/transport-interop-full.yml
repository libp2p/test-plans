name: Full libp2p Transport Interop Tests

on:
  # Manual trigger
  workflow_dispatch:

  # Run it weekly on Mondays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 1'

jobs:

  check-changes:
    runs-on: [self-hosted, linux, x64, ephemeral]

    outputs:
      result: ${{ steps.check.outputs.changed }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0                     # need full history

      - id: check
        run: |
          # 7 days ago in git-friendly format
          SINCE=$(git log -1 --format=%cd --date=iso --since="7 days ago" || echo "1970-01-01")

          # Count commits that touched anything under transport-interop/ except dashboard.md
          CHANGED=$(git log --oneline --since="$SINCE" \
                    -- "transport-interop/**" \
                    ":!transport-interop/dashboard.md" | wc -l)

          if [ "$CHANGED" -gt 0 ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

  full-transport-interop-test:
    needs: check-changes
    # Only execute the scheduled run if changed have happened in the last 7 days
    if: >
      github.event_name != 'schedule' ||
      (github.event_name == 'schedule' && needs.check-changes.outputs.result == 'true')

    runs-on: [self-hosted, linux, x64, ephemeral]
    
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/run-transport-interop-test
        with:
          worker-count: 8
          cache-dir: /srv/cache
          test-root: "transport-interop"
