name: libp2p full transport interop test

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      tests-filter:
        description: 'Pipe separated list of tests to run (e.g. go-v0.42|js-v3.x)'
        required: false
        default: ''
        type: string
      update-readme:
        description: 'Update README.md with results?'
        required: false
        default: 'true'
        type: boolean

  # Run it weekly on Mondays at 2 AM UTC
  schedule:
    - cron: '0 2 * * 1'

jobs:

  check-changes:
    runs-on: [self-hosted, linux, x64, ephemeral]

    outputs:
      result: ${{ steps.check.outputs.changed }}

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.WRITE_README_AND_DASHBOARD }}
          fetch-depth: 0

      - id: check
        run: |
          # 7 days ago in git-friendly format
          SINCE=$(git log -1 --format=%cd --date=iso --since="7 days ago" || echo "1970-01-01")

          # Count commits that touched anything under transport-interop/ except dashboard.md
          CHANGED=$(git log --oneline --since="$SINCE" \
                    -- "transport-interop/**" \
                    ":!transport-interop/dashboard.md" | wc -l)

          if [ "$CHANGED" -gt 0 ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

  full-transport-interop-test:
    needs: check-changes
    # Only execute the scheduled run if changed have happened in the last 7 days
    if: >
      github.event_name != 'schedule' ||
      (github.event_name == 'schedule' && needs.check-changes.outputs.result == 'true')

    runs-on: [self-hosted, linux, x64, ephemeral]
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.WRITE_README_AND_DASHBOARD }}
          ref: ${{ github.head_ref }}
          fetch-depth: 0

      # Build test-ignore from transport-interop/test-ignore.txt if it exists
      - name: Read test-ignore file
        id: test-ignore
        run: |
          TI_DIR="$GITHUB_WORKSPACE/transport-interop"
          if [ -f "$TI_DIR/test-ignore.txt" ]; then
            TEST_IGNORE=$(cat "$TI_DIR/test-ignore.txt")
            echo "Setting: test-ignore=$TEST_IGNORE"
            echo "test-ignore=$TEST_IGNORE" >> $GITHUB_OUTPUT
          else
            echo "Setting: test-ignore=''"
            echo "test-ignore=" >> $GITHUB_OUTPUT
          fi

      - name: Build test-root
        id: build-test-root
        run: |
          TI_DIR="$GITHUB_WORKSPACE/transport-interop"
          echo "Setting: test-root=$TI_DIR"
          echo "test-root=$TI_DIR" >> $GITHUB_OUTPUT

      - uses: ./.github/actions/run-transport-interop-test
        with:
          worker-count: 8
          cache-dir: /srv/cache
          test-filter: ${{ inputs.test-filter }}
          test-ignore: ${{ steps.test-ignore.outputs.test-ignore }}
          test-root: ${{ steps.build-test-root.outputs.test-root }}
          update-readme: ${{ inputs.update-readme }}
          gh-token: ${{ secrets.WRITE_README_AND_DASHBOARD }}
